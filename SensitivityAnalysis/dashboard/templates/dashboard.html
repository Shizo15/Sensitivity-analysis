<!DOCTYPE html>
<html lang="en">
{% load l10n %}
<head>
  <meta charset="UTF-8" />
  <title>YouTube Comment Sentiment Analysis ‚Äî Results</title>
  <style>
    body{font-family:Arial, sans-serif;background:#f9fafb;margin:0}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .header{background:white;padding:20px 24px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.06);display:flex;gap:16px;align-items:center}
    .thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;background:#eee}
    .h-title{font-size:20px;margin:0}
    .meta{color:#555;margin-top:6px}
    .grid{margin-top:20px;display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:white;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.06);padding:18px}
    .card h3{margin:0 0 10px;color:#1e3a8a;font-size:16px}
    .placeholder{height:220px;border:2px dashed #cbd5e1;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#64748b;text-align:center;padding:8px}
    .kpi{display:flex;align-items:center;justify-content:center;height:220px;font-size:34px;font-weight:700;color:#0f172a}
    .kpi small{font-weight:400;font-size:16px;margin-left:8px;color:#334155}
    .back{display:inline-block;margin-top:16px;text-decoration:none;background:#2563eb;color:#fff;padding:8px 14px;border-radius:8px}

    /* gauge for average sentiment */
    .gauge-wrap{
      background:#e5e7eb;
      border-radius:999px;
      height:22px;
      padding:2px;
      display:flex;
      align-items:center;
      margin-top:14px;
      width:100%;
      max-width:360px;
      position:relative;
    }
    .gauge-fill{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#ef4444,#eab308,#22c55e);
      width:0;
      transition:width .4s ease;
    }
    .gauge-text{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:700;
      color:#0f172a;
      pointer-events:none;
    }

    /* scrollable comments table */
    .comments-box{
      margin-top: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      max-height: 220px;   /* scroll height inside the card */
      overflow-y: auto;
      overflow-x: hidden; /* Ukrywamy poziomy pasek przewijania */
    }
    .comments-table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      /* POPRAWKA 1: Sztywny uk≈Çad tabeli */
      table-layout: fixed;
    }
    .comments-table th, .comments-table td{
      padding: 10px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;

      /* POPRAWKA 2: Wymuszenie zawijania tekstu */
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    .comments-table th{
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      text-align: left;
      color: #1e3a8a;
      font-weight: 700;
    }
    .badge{
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: capitalize;
      background: #f1f5f9;
      color: #0f172a;
      white-space: nowrap; /* Badge nie powinien siƒô ≈Çamaƒá */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      {% if thumbnail_url %}
        <img class="thumb" src="{{ thumbnail_url }}" alt="thumbnail" />
      {% else %}
        <div class="thumb"></div>
      {% endif %}

      <div>
        <h1 class="h-title">YouTube Comment Sentiment Analysis ‚Äî Results</h1>
        <div class="meta">
          {% if video_title %}<strong>Title:</strong> {{ video_title }} &nbsp;‚Ä¢&nbsp;{% endif %}
          {% if channel_title %}<strong>Channel:</strong> {{ channel_title }} &nbsp;‚Ä¢&nbsp;{% endif %}
          {% if published_at %}<strong>Published:</strong> {{ published_at|slice:":10" }}{% endif %}
          {% if like_count %} &nbsp;‚Ä¢&nbsp; <strong>Likes:</strong> {{ like_count }} üëç{% endif %}
          {% if view_count %} &nbsp;‚Ä¢&nbsp; <strong>Views:</strong> {{ view_count }} üëÄ{% endif %}
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card" style="grid-column: span 6;">
        <h3>Comments analyzed</h3>

        <div style="font-size:28px;font-weight:800;color:#0f172a;margin-top:6px;">
          {{ comment_count|default:"0" }}
          <span style="font-weight:400;font-size:14px;color:#334155;">comments</span>
        </div>

        <div class="comments-box">
          <table class="comments-table">
            <thead>
              <tr>
                <th style="width:75%;">Comment</th>
                <th style="width:25%;">Sentiment</th>
              </tr>
            </thead>
            <tbody>
              {% for item in classified_comments %}
                <tr>
                  <td>{{ item.text }}</td>
                  <td><span class="badge">{{ item.label }}</span></td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="2" style="color:#64748b;">No comments to display.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>Sentiment share</h3>
        {% if sentiment_share %}
          <canvas id="sentimentPie" style="max-width:320px; margin:10px auto 0 auto;"></canvas>
        {% else %}
          <div class="placeholder">
            No sentiment data available.
          </div>
        {% endif %}
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>Overall sentiment (avg)</h3>
        {% if avg_sentiment_score is not None %}
          <div class="kpi" style="flex-direction:column; height:auto;">
            <div>
              {{ avg_sentiment_score|floatformat:2 }}
              <small>(-1 = negative, 0 = neutral, 1 = positive)</small>
            </div>

            {% if avg_sentiment_percent is not None %}
              <div class="gauge-wrap">
                <div class="gauge-fill" style="width: {{ avg_sentiment_percent|unlocalize }}%;"></div>
                <div class="gauge-text">{{ avg_sentiment_percent|floatformat:0 }}%</div>
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="placeholder">
            No sentiment score available.
          </div>
        {% endif %}
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>Dominant sentiment</h3>
        {% if dominant_sentiment %}
          <div class="kpi" style="flex-direction:column; height:auto;">
            <div style="font-size:30px; text-transform:capitalize;">
              {{ dominant_sentiment }}
            </div>
            {% if dominant_sentiment_percent %}
              <div style="margin-top:8px; font-size:16px; color:#475569;">
                {{ dominant_sentiment_percent|floatformat:1 }}% of analyzed comments
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="placeholder">
            No dominant sentiment detected.
          </div>
        {% endif %}
      </div>

    </div>

    <a class="back" href="{% url 'sentiment_dashboard' %}">‚Üê Back</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function () {
      const dataObj = {{ sentiment_share_json|default:"{}"|safe }};
      const keys = Object.keys(dataObj);
      if (!keys.length) return;

      const canvas = document.getElementById('sentimentPie');
      if (!canvas) return;

      const orderedClasses = ["positive", "neutral", "negative"];
      const labels = ["Positive", "Neutral", "Negative"];
      const colors = ["#22c55e", "#facc15", "#ef4444"];
      const values = orderedClasses.map(cls => dataObj[cls] || 0);

      new Chart(canvas, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const label = ctx.label || '';
                  const v = ctx.parsed || 0;
                  return label + ': ' + v + '%';
                }
              }
            }
          }
        }
      });
    })();
  </script>
</body>
</html>